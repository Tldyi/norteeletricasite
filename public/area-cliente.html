<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Área do Cliente - Nort Elétrica</title>
  <meta name="description" content="Acesse sua Área do Cliente na Nort Elétrica para acompanhar pedidos, transporte e manutenção em São José do Norte/RS.">
  <link rel="preload" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" as="style">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    :root {
      --primary-blue: #2563eb;
      --dark-blue: #1e40af;
      --solar-green: #22c55e;
      --light-bg: #f9fafb;
      --shadow-sm: 0 4px 10px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 10px 20px rgba(0, 0, 0, 0.1);
    }
    body { font-family: 'Poppins', sans-serif; background: var(--light-bg); padding-top: 80px; transition: background-color 0.3s, color 0.3s; }
    body.dark { background: #1f2937; color: #f3f4f6; }
    body.dark .tab { background: #374151; }
    body.dark .tab.active { background: linear-gradient(135deg, #60a5fa, #1e40af); }
    body.dark .tab-content { background: #374151; }
    body.dark .order-card { background: #4b5563; }
    body.dark .btn-modern { background: linear-gradient(135deg, #34d399, #16a34a); }
    body.dark #auth-section { background: linear-gradient(135deg, #4b5563, #1f2937); }
    header { background: linear-gradient(135deg, var(--primary-blue), var(--dark-blue)); position: fixed; top: 0; width: 100%; z-index: 50; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); }
    .btn-modern { background: linear-gradient(135deg, var(--solar-green), #16a34a); color: white; padding: 12px 24px; border-radius: 8px; transition: all 0.3s ease; display: inline-flex; align-items: center; font-weight: 600; box-shadow: var(--shadow-sm); }
    .btn-modern:hover { transform: translateY(-3px) scale(1.05); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15); }
    footer { background: linear-gradient(135deg, var(--dark-blue), var(--primary-blue)); }
    section { padding: 5rem 1rem; }
    h1, h2, h3 { font-weight: 700; }
    h2 { font-size: 2.5rem; letter-spacing: 0.025em; margin-bottom: 1.5rem; background: linear-gradient(135deg, var(--primary-blue), var(--solar-green)); -webkit-background-clip: text; color: transparent; }
    @media (max-width: 768px) { h2 { font-size: 1.5rem; } .grid-cols-2 { grid-template-columns: 1fr; } }
    .back-to-top { position: fixed; bottom: 30px; right: 30px; background: linear-gradient(135deg, var(--primary-blue), var(--dark-blue)); color: white; padding: 12px; border-radius: 50%; display: none; z-index: 1000; transition: all 0.3s ease; box-shadow: var(--shadow-sm); }
    .back-to-top:hover { transform: scale(1.1); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15); }
    .back-to-top.show { display: block; }
    a:focus, button:focus { outline: 2px solid var(--primary-blue); outline-offset: 2px; }
    #order-status { display: none; opacity: 0; transition: opacity 0.5s ease; }
    #order-status.active { display: block; opacity: 1; }
    .tab { cursor: pointer; padding: 12px 24px; background: #e5e7eb; border-radius: 8px 8px 0 0; transition: all 0.3s ease; font-weight: 600; }
    .tab.active { background: linear-gradient(135deg, var(--primary-blue), var(--dark-blue)); color: white; }
    .tab-content { display: none; padding: 20px; background: white; border-radius: 0 0 8px 8px; box-shadow: var(--shadow-md); transition: transform 0.3s ease; }
    .tab-content.active { display: block; transform: translateY(0); }
    #auth-section { background: linear-gradient(135deg, #fff, #f1f5f9); padding: 24px; border-radius: 12px; box-shadow: var(--shadow-md); transition: transform 0.3s ease; }
    #auth-section:hover { transform: translateY(-5px); }
    .order-card { background: white; padding: 20px; border-radius: 12px; box-shadow: var(--shadow-md); margin-bottom: 20px; transition: transform 0.3s ease; }
    .order-card:hover { transform: translateY(-5px); }
    .status-dot { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
    .status-dot.green { background: var(--solar-green); }
    .status-dot.yellow { background: #eab308; }
    .status-dot.red { background: #ef4444; }
    .history-timeline { position: relative; padding-left: 30px; }
    .history-item { position: relative; margin-bottom: 20px; }
    .history-item::before { content: ''; position: absolute; left: -25px; top: 5px; width: 10px; height: 10px; background: var(--primary-blue); border-radius: 50%; z-index: 1; transition: all 0.3s ease; }
    .history-timeline::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 2px; background: var(--primary-blue); }
    .notification { position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, var(--solar-green), #16a34a); color: white; padding: 10px 20px; border-radius: 8px; box-shadow: var(--shadow-md); z-index: 1000; animation: fadeInOut 3s ease forwards; }
    @keyframes fadeInOut { 0% { opacity: 0; transform: translateY(-20px); } 20% { opacity: 1; transform: translateY(0); } 80% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-20px); display: none; } }
    .preview-img { max-width: 200px; margin-top: 10px; border-radius: 8px; box-shadow: var(--shadow-sm); }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; justify-content: center; align-items: center; }
    .modal-content { background: white; padding: 20px; border-radius: 12px; box-shadow: var(--shadow-md); max-width: 500px; width: 90%; }
    body.dark .modal-content { background: #4b5563; }
    input, textarea, select { transition: all 0.3s ease; }
    input:focus, textarea:focus, select:focus { border-color: var(--primary-blue); box-shadow: 0 0 5px rgba(37, 99, 235, 0.5); }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="text-white py-4">
    <div class="container mx-auto px-4 flex justify-between items-center">
      <div class="flex items-center space-x-4">
        <a href="index.html" class="flex flex-col">
          <span class="text-2xl font-bold tracking-tight">Nort Elétrica</span>
          <span class="text-sm text-blue-200 hidden md:block">Energia Inteligente para Todos</span>
        </a>
      </div>
      <nav class="hidden md:flex items-center space-x-6">
        <a href="index.html" class="hover:text-blue-200 transition-colors">Home</a>
        <a href="index.html#services" class="hover:text-blue-200 transition-colors">Serviços</a>
        <a href="index.html#contact" class="hover:text-blue-200 transition-colors">Contato</a>
        <button id="theme-toggle" class="btn-modern">Tema Escuro</button>
      </nav>
    </div>
  </header>

  <!-- Área do Cliente -->
  <section>
    <div class="container mx-auto px-4">
      <nav class="mb-6 text-gray-600">
        <a href="index.html" class="hover:text-[var(--primary-blue)]">Home</a> > 
        <span>Área do Cliente</span>
      </nav>
      <h1 class="text-4xl font-bold text-center mb-12 text-[var(--primary-blue)]">Área do Cliente</h1>
      
      <!-- Abas de Login e Cadastro -->
      <div id="auth-section" class="max-w-md mx-auto">
        <div class="flex justify-between mb-4">
          <div id="tab-login" class="tab active" onclick="switchAuthTab('login')" aria-selected="true" role="tab">Login</div>
          <div id="tab-cadastro" class="tab" onclick="switchAuthTab('cadastro')" aria-selected="false" role="tab">Cadastro</div>
        </div>

        <!-- Formulário de Login -->
        <div id="login-content" class="tab-content active" role="tabpanel">
          <form id="login-form" class="space-y-4">
            <div>
              <label for="login-email" class="block text-gray-700 font-semibold">E-mail</label>
              <input type="email" id="login-email" placeholder="E-mail" class="border border-gray-300 p-3 w-full rounded-lg focus:ring-2 focus:ring-[var(--primary-blue)]" required aria-label="E-mail">
              <p id="login-email-error" class="text-red-500 text-sm hidden">Insira um e-mail válido.</p>
            </div>
            <div>
              <label for="login-password" class="block text-gray-700 font-semibold">Senha</label>
              <input type="password" id="login-password" placeholder="Senha" class="border border-gray-300 p-3 w-full rounded-lg focus:ring-2 focus:ring-[var(--primary-blue)]" required aria-label="Senha">
              <p id="login-password-error" class="text-red-500 text-sm hidden">Insira sua senha.</p>
            </div>
            <button type="submit" class="btn-modern w-full">Entrar</button>
            <p id="login-success" class="hidden text-green-600 text-center mt-4">Login realizado com sucesso!</p>
            <a href="#" onclick="showResetPasswordModal()" class="text-[var(--primary-blue)] hover:underline text-sm">Esqueceu sua senha?</a>
          </form>
        </div>

        <!-- Formulário de Cadastro -->
        <div id="cadastro-content" class="tab-content" role="tabpanel">
          <form id="cadastro-form" class="space-y-4">
            <div>
              <input type="text" id="cadastro-name" placeholder="Nome" class="border border-gray-300 p-3 w-full rounded-lg focus:ring-2 focus:ring-[var(--primary-blue)]" required aria-label="Nome">
              <p id="cadastro-name-error" class="text-red-500 text-sm hidden">Insira seu nome.</p>
            </div>
            <div>
              <input type="email" id="cadastro-email" placeholder="E-mail" class="border border-gray-300 p-3 w-full rounded-lg focus:ring-2 focus:ring-[var(--primary-blue)]" required aria-label="E-mail">
              <p id="cadastro-email-error" class="text-red-500 text-sm hidden">Insira um e-mail válido.</p>
            </div>
            <div>
              <input type="tel" id="cadastro-phone" placeholder="Telefone (opcional)" class="border border-gray-300 p-3 w-full rounded-lg focus:ring-2 focus:ring-[var(--primary-blue)]" aria-label="Telefone">
              <p id="cadastro-phone-error" class="text-red-500 text-sm hidden">Insira um telefone válido.</p>
            </div>
            <div>
              <textarea id="cadastro-address" placeholder="Endereço Padrão (opcional)" class="border border-gray-300 p-3 w-full rounded-lg" rows="3" aria-label="Endereço Padrão"></textarea>
            </div>
            <div>
              <input type="password" id="cadastro-password" placeholder="Senha" class="border border-gray-300 p-3 w-full rounded-lg focus:ring-2 focus:ring-[var(--primary-blue)]" required aria-label="Senha">
              <p id="cadastro-password-error" class="text-red-500 text-sm hidden">Insira uma senha.</p>
            </div>
            <div>
              <input type="password" id="cadastro-password-confirm" placeholder="Confirmar Senha" class="border border-gray-300 p-3 w-full rounded-lg focus:ring-2 focus:ring-[var(--primary-blue)]" required aria-label="Confirmar Senha">
              <p id="cadastro-password-confirm-error" class="text-red-500 text-sm hidden">As senhas não coincidem.</p>
            </div>
            <button type="submit" class="btn-modern w-full">Cadastrar</button>
            <p id="cadastro-success" class="hidden text-green-600 text-center mt-4">Cadastro realizado com sucesso!</p>
          </form>
        </div>
      </div>

      <!-- Área Após Login -->
      <div id="order-status" class="max-w-4xl mx-auto mt-8" style="display: none;">
        <div class="flex justify-between mb-4">
          <div id="tab-orders" class="tab active" onclick="switchTab('orders')" aria-selected="true" role="tab">Pedidos</div>
          <div id="tab-profile" class="tab" onclick="switchTab('profile')" aria-selected="false" role="tab">Meu Perfil</div>
          <div id="tab-support" class="tab" onclick="switchTab('support')" aria-selected="false" role="tab">Suporte</div>
          <div id="tab-payments" class="tab" onclick="switchTab('payments')" aria-selected="false" role="tab">Pagamentos</div>
        </div>

        <!-- Pedidos -->
        <div id="orders-content" class="tab-content active" role="tabpanel">
          <h2 class="text-3xl font-bold text-center mb-8">Seus Pedidos</h2>

          <!-- Dashboard -->
          <div class="bg-white p-6 rounded-lg shadow-lg mb-8">
            <h3 class="text-xl font-semibold mb-4 text-[var(--primary-blue)]">Estatísticas</h3>
            <canvas id="client-stats-chart" class="w-full h-64"></canvas>
            <div id="client-stats-text" class="mt-4 text-gray-700"></div>
          </div>

          <!-- Exportação -->
          <div class="mb-6 flex space-x-4">
            <button onclick="exportClientToCSV()" class="btn-modern">Exportar CSV</button>
            <button onclick="exportClientToPDF()" class="btn-modern">Exportar PDF</button>
            <button onclick="showRequestServiceModal()" class="btn-modern">Solicitar Serviço</button>
          </div>

          <!-- Pedidos Ativos -->
          <div class="mb-12">
            <h3 class="text-xl font-semibold text-[var(--primary-blue)] mb-4">Pedidos Ativos</h3>
            <div id="active-orders" class="space-y-6">
              <!-- Pedidos ativos serão preenchidos dinamicamente -->
            </div>
            <div class="mt-4 flex justify-between">
              <button id="prev-page-active" class="btn-modern" onclick="changePage('active', -1)">Anterior</button>
              <span id="active-page-info" class="text-gray-700"></span>
              <button id="next-page-active" class="btn-modern" onclick="changePage('active', 1)">Próximo</button>
            </div>
          </div>

          <!-- Histórico de Pedidos -->
          <div>
            <h3 class="text-xl font-semibold text-[var(--primary-blue)] mb-4">Histórico de Pedidos</h3>
            <div id="historico-list" class="space-y-6">
              <!-- Histórico será preenchido dinamicamente -->
            </div>
            <div class="mt-4 flex justify-between">
              <button id="prev-page-historico" class="btn-modern" onclick="changePage('historico', -1)">Anterior</button>
              <span id="historico-page-info" class="text-gray-700"></span>
              <button id="next-page-historico" class="btn-modern" onclick="changePage('historico', 1)">Próximo</button>
            </div>
          </div>
        </div>

        <!-- Perfil -->
        <div id="profile-content" class="tab-content" role="tabpanel">
          <h2 class="text-3xl font-bold text-center mb-8">Meu Perfil</h2>
          <form id="profile-form" class="bg-white p-6 rounded-lg shadow-lg space-y-4">
            <div>
              <label class="block text-gray-700 font-semibold">Nome</label>
              <input type="text" id="profile-name" class="border border-gray-300 p-3 w-full rounded-lg" required aria-label="Nome">
            </div>
            <div>
              <label class="block text-gray-700 font-semibold">E-mail</label>
              <input type="email" id="profile-email" class="border border-gray-300 p-3 w-full rounded-lg" disabled aria-label="E-mail">
            </div>
            <div>
              <label class="block text-gray-700 font-semibold">Telefone</label>
              <input type="tel" id="profile-phone" class="border border-gray-300 p-3 w-full rounded-lg" aria-label="Telefone">
            </div>
            <div>
              <label class="block text-gray-700 font-semibold">Endereço Padrão</label>
              <textarea id="profile-address" class="border border-gray-300 p-3 w-full rounded-lg" rows="3" aria-label="Endereço Padrão"></textarea>
            </div>
            <div>
              <label class="block text-gray-700 font-semibold">Foto de Perfil</label>
              <input type="file" id="profile-photo" accept="image/*" class="border border-gray-300 p-3 w-full rounded-lg" onchange="previewProfilePhoto(this)" aria-label="Foto de Perfil">
              <img id="profile-photo-preview" class="preview-img mt-2 hidden" src="" alt="Prévia da foto de perfil">
            </div>
            <div>
              <label class="block text-gray-700 font-semibold">Receber Notificações por E-mail</label>
              <input type="checkbox" id="profile-notify" class="border border-gray-300 p-3 rounded-lg" aria-label="Receber Notificações por E-mail">
            </div>
            <button type="submit" class="btn-modern w-full">Salvar Alterações</button>
          </form>
        </div>

        <!-- Suporte -->
        <div id="support-content" class="tab-content" role="tabpanel">
          <h2 class="text-3xl font-bold text-center mb-8">Suporte</h2>
          <form id="support-form" class="bg-white p-6 rounded-lg shadow-lg space-y-4">
            <div>
              <label class="block text-gray-700 font-semibold">Assunto</label>
              <input type="text" id="support-subject" class="border border-gray-300 p-3 w-full rounded-lg" required aria-label="Assunto">
            </div>
            <div>
              <label class="block text-gray-700 font-semibold">Mensagem</label>
              <textarea id="support-message" class="border border-gray-300 p-3 w-full rounded-lg" rows="4" required aria-label="Mensagem"></textarea>
            </div>
            <button type="submit" class="btn-modern w-full">Enviar</button>
          </form>
        </div>

        <!-- Pagamentos -->
        <div id="payments-content" class="tab-content" role="tabpanel">
          <h2 class="text-3xl font-bold text-center mb-8">Histórico de Pagamentos</h2>
          <div id="payments-list" class="space-y-6">
            <!-- Histórico de pagamentos será preenchido dinamicamente -->
          </div>
        </div>
      </div>

      <!-- Modal de Recuperação de Senha -->
      <div id="reset-password-modal" class="modal">
        <div class="modal-content">
          <h3 class="text-xl font-semibold mb-4 text-[var(--primary-blue)]">Recuperar Senha</h3>
          <form id="reset-password-form" class="space-y-4">
            <div>
              <input type="email" id="reset-email" placeholder="E-mail" class="border border-gray-300 p-3 w-full rounded-lg" required aria-label="E-mail para recuperação">
              <p id="reset-email-error" class="text-red-500 text-sm hidden">Insira um e-mail válido.</p>
            </div>
            <button type="submit" class="btn-modern w-full">Enviar Código</button>
            <button type="button" onclick="hideResetPasswordModal()" class="btn-modern bg-gray-500 w-full mt-2">Cancelar</button>
          </form>
        </div>
      </div>

      <!-- Modal de Solicitação de Serviço -->
      <div id="request-service-modal" class="modal">
        <div class="modal-content">
          <h3 class="text-xl font-semibold mb-4 text-[var(--primary-blue)]">Solicitar Serviço</h3>
          <form id="request-service-form" class="space-y-4">
            <div>
              <label class="block text-gray-700 font-semibold">Serviço</label>
              <select id="request-service" class="border border-gray-300 p-3 w-full rounded-lg" required aria-label="Serviço">
                <option value="">Selecione o serviço</option>
                <option value="Sistemas Fotovoltaicos">Sistemas Fotovoltaicos</option>
                <option value="Elétrica Predial">Elétrica Predial</option>
                <option value="Elétrica Industrial">Elétrica Industrial</option>
                <option value="Automação Residencial">Automação Residencial</option>
                <option value="Cabeamento Estruturado">Cabeamento Estruturado</option>
                <option value="CFTV e Monitoramento">CFTV e Monitoramento</option>
              </select>
            </div>
            <div>
              <label class="block text-gray-700 font-semibold">Descrição</label>
              <textarea id="request-description" class="border border-gray-300 p-3 w-full rounded-lg" rows="4" required aria-label="Descrição"></textarea>
            </div>
            <button type="submit" class="btn-modern w-full">Enviar Solicitação</button>
            <button type="button" onclick="hideRequestServiceModal()" class="btn-modern bg-gray-500 w-full mt-2">Cancelar</button>
          </form>
        </div>
      </div>

      <!-- Modal de Confirmação de Pagamento -->
      <div id="payment-confirmation-modal" class="modal">
        <div class="modal-content">
          <h3 class="text-xl font-semibold mb-4 text-[var(--primary-blue)]">Pagamento Confirmado</h3>
          <div id="payment-confirmation-details" class="space-y-2"></div>
          <button onclick="hidePaymentConfirmationModal()" class="btn-modern w-full mt-4">Fechar</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Botão Voltar ao Topo -->
  <a href="#" class="back-to-top" aria-label="Voltar ao topo"><i class="fas fa-arrow-up"></i></a>

  <!-- Footer -->
  <footer class="text-white py-12">
    <div class="container mx-auto px-4 text-center">
      <p id="footer-year" class="text-blue-200">© 2025 Nort Elétrica. Todos os direitos reservados.</p>
      <p class="mt-2">
        <a href="politica-de-privacidade.html" class="text-blue-200 hover:underline">Política de Privacidade</a> | 
        <a href="termos-de-uso.html" class="text-blue-200 hover:underline">Termos de Uso</a> | 
        <a href="area-cliente.html" class="text-blue-200 hover:underline">Área do Cliente</a>
      </p>
    </div>
  </footer>

  <!-- Scripts -->
  <script src="https://kit.fontawesome.com/a076d05399.js" defer></script>
  <script>
    // Define a URL base dinamicamente com base no ambiente
    const API_BASE_URL = window.location.hostname === 'localhost' ? 'http://localhost:3000' : '';

    document.getElementById('footer-year').innerHTML = `© ${new Date().getFullYear()} Nort Elétrica. Todos os direitos reservados.`;

    const backToTop = document.querySelector('.back-to-top');
    window.addEventListener('scroll', () => backToTop.classList.toggle('show', window.scrollY > 100));
    backToTop.addEventListener('click', (e) => { e.preventDefault(); window.scrollTo({ top: 0, behavior: 'smooth' }); });

    document.querySelectorAll('img').forEach(img => img.setAttribute('loading', 'lazy'));

    let currentUser = '';
    let currentOrders = [];
    let activePage = 1;
    let historicoPage = 1;
    const limit = 5;

    // Notificação
    function showNotification(message) {
      const notification = document.createElement('div');
      notification.className = 'notification';
      notification.textContent = message;
      document.body.appendChild(notification);
      setTimeout(() => notification.remove(), 3000);
    }

    // Alternar Abas de Autenticação (Login/Cadastro)
    function switchAuthTab(tab) {
      document.querySelectorAll('#auth-section .tab').forEach(t => { t.classList.remove('active'); t.setAttribute('aria-selected', 'false'); });
      document.querySelectorAll('#auth-section .tab-content').forEach(c => c.classList.remove('active'));
      const selectedTab = document.getElementById(`tab-${tab}`);
      selectedTab.classList.add('active');
      selectedTab.setAttribute('aria-selected', 'true');
      document.getElementById(`${tab}-content`).classList.add('active');
    }

    // Alternar Abas Após Login (Pedidos/Perfil/Support/Payments)
    function switchTab(tab) {
      document.querySelectorAll('#order-status .tab').forEach(t => { t.classList.remove('active'); t.setAttribute('aria-selected', 'false'); });
      document.querySelectorAll('#order-status .tab-content').forEach(c => c.classList.remove('active'));
      const selectedTab = document.getElementById(`tab-${tab}`);
      selectedTab.classList.add('active');
      selectedTab.setAttribute('aria-selected', 'true');
      document.getElementById(`${tab}-content`).classList.add('active');
    }

    // Alternar Tema
    const themeToggle = document.getElementById('theme-toggle');
    themeToggle.addEventListener('click', () => {
      document.body.classList.toggle('dark');
      const isDark = document.body.classList.contains('dark');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      themeToggle.textContent = isDark ? 'Tema Claro' : 'Tema Escuro';
    });
    if (localStorage.getItem('theme') === 'dark') {
      document.body.classList.add('dark');
      themeToggle.textContent = 'Tema Claro';
    }

    // Exibir Pedidos
    function displayOrders(pedidos, containerId) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      pedidos.forEach(pedido => {
        const orderCard = document.createElement('div');
        orderCard.className = 'order-card';
        orderCard.innerHTML = `
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-semibold text-[var(--primary-blue)]">${pedido.numero}</h3>
            <span class="status-dot ${pedido.status === 'Em Trânsito' ? 'green' : pedido.status === 'Aguardando Pagamento' ? 'yellow' : pedido.status === 'Concluído' ? 'red' : '#16a34a'}"></span>
            <span class="text-gray-700 font-semibold">${pedido.status}</span>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <p class="text-gray-700"><strong>Data do Pedido:</strong> ${pedido.data}</p>
              <p class="text-gray-700"><strong>Serviço:</strong> ${pedido.servico}</p>
              <p class="text-gray-700"><strong>Descrição:</strong> ${pedido.descricao}</p>
              <p class="text-gray-700"><strong>Transporte:</strong> ${pedido.transporte}</p>
            </div>
            <div>
              <p class="text-gray-700"><strong>Previsão de Entrega:</strong> ${pedido.entrega}</p>
              <p class="text-gray-700"><strong>Previsão de Instalação:</strong> ${pedido.instalacao}</p>
              <p class="text-gray-700"><strong>Próxima Manutenção:</strong> ${pedido.manutencao}</p>
              <p class="text-gray-700"><strong>Endereço:</strong> ${pedido.endereco || 'Não informado'}</p>
              <p class="text-gray-700"><strong>Pagamento:</strong> ${pedido.metodo_pagamento || 'Não informado'}</p>
              <p class="text-gray-700"><strong>Valor:</strong> R$ ${pedido.valor || 0}</p>
              <p class="text-gray-700"><strong>Comprovante:</strong> ${pedido.comprovante ? '<a href="data:image/jpeg;base64,' + pedido.comprovante + '" target="_blank">Ver</a>' : 'Não enviado'}</p>
            </div>
          </div>
          <div class="mt-6">
            <h4 class="text-lg font-semibold text-[var(--primary-blue)] mb-4">Histórico</h4>
            <div class="history-timeline">
              ${pedido.historico.split(';').map(item => `<div class="history-item"><p class="text-gray-700">${item}</p></div>`).join('')}
            </div>
          </div>
          <div class="mt-6 text-center space-x-4 flex flex-wrap justify-center">
            <a href="mailto:lucassjn1999@gmail.com" class="btn-modern">Fale Conosco</a>
            ${pedido.status === 'Aguardando Pagamento' ? `
              <button class="btn-modern" onclick="showPaymentForm(${pedido.id}, '${pedido.numero}')">Informar Pagamento</button>
            ` : pedido.status === 'Em Trânsito' ? `
              <a href="https://wa.me/5533981087746?text=Olá, quero rastrear meu pedido ${pedido.numero} - Código: ${pedido.transporte}" class="btn-modern">Rastrear</a>
            ` : `
              <a href="index.html#contact" class="btn-modern">Novo Pedido</a>
            `}
          </div>
          ${pedido.status === 'Aguardando Pagamento' ? `
            <div id="payment-form-${pedido.id}" class="mt-4 hidden">
              <form class="space-y-4" onsubmit="submitPayment(event, ${pedido.id}, '${pedido.historico}')">
                <div>
                  <label class="block text-gray-700 font-semibold">Endereço de Entrega</label>
                  <textarea id="address-${pedido.id}" placeholder="Rua, número, cidade, estado" class="border border-gray-300 p-3 w-full rounded-lg" rows="3" required aria-label="Endereço de Entrega"></textarea>
                </div>
                <div>
                  <label class="block text-gray-700 font-semibold">Método de Pagamento</label>
                  <select id="payment-method-${pedido.id}" class="border border-gray-300 p-3 w-full rounded-lg" required aria-label="Método de Pagamento">
                    <option value="">Selecione</option>
                    <option value="PIX">PIX</option>
                    <option value="Cartão de Crédito">Cartão de Crédito</option>
                    <option value="Boleto">Boleto</option>
                  </select>
                </div>
                <div>
                  <label class="block text-gray-700 font-semibold">Comprovante (imagem)</label>
                  <input type="file" id="comprovante-${pedido.id}" accept="image/*" class="border border-gray-300 p-3 w-full rounded-lg" onchange="previewComprovante(${pedido.id}, this)" aria-label="Comprovante">
                  <img id="comprovante-preview-${pedido.id}" class="preview-img hidden" src="" alt="Prévia do comprovante">
                </div>
                <button type="submit" class="btn-modern w-full">Confirmar Pagamento</button>
              </form>
            </div>
          ` : ''}
        `;
        container.appendChild(orderCard);
      });
    }

    // Exibir Histórico de Pagamentos
    function displayPayments(pagamentos) {
      const container = document.getElementById('payments-list');
      container.innerHTML = '';
      pagamentos.forEach(p => {
        const paymentCard = document.createElement('div');
        paymentCard.className = 'order-card';
        paymentCard.innerHTML = `
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-semibold text-[var(--primary-blue)]">Pagamento #${p.id}</h3>
            <span class="text-gray-700 font-semibold">Pedido: ${p.numero}</span>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <p class="text-gray-700"><strong>Data:</strong> ${p.data}</p>
              <p class="text-gray-700"><strong>Valor:</strong> R$ ${p.valor}</p>
              <p class="text-gray-700"><strong>Método:</strong> ${p.metodo}</p>
            </div>
          </div>
        `;
        container.appendChild(paymentCard);
      });
    }

    // Carregar Pedidos com Paginação
    function loadOrders(usuario, containerId, page) {
      fetch(`${API_BASE_URL}/api/pedidos/${usuario}?page=${page}&limit=${limit}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            if (containerId === 'active-orders') {
              displayOrders(data.pedidos.filter(p => p.status !== 'Concluído'), containerId);
              updatePagination('active', data.total, page);
            } else {
              displayOrders(data.pedidos, containerId);
              updatePagination('historico', data.total, page);
            }
          } else {
            alert('Erro ao carregar pedidos: ' + data.message);
          }
        })
        .catch(err => console.error('Erro ao carregar pedidos:', err));
    }

    // Atualizar Paginação
    function updatePagination(type, total, page) {
      const totalPages = Math.ceil(total / limit);
      const pageInfo = document.getElementById(`${type}-page-info`);
      pageInfo.textContent = `Página ${page} de ${totalPages}`;
      document.getElementById(`prev-page-${type}`).disabled = page === 1;
      document.getElementById(`next-page-${type}`).disabled = page === totalPages;
    }

    // Mudar Página
    function changePage(type, delta) {
      if (type === 'active') {
        activePage += delta;
        loadOrders(currentUser, 'active-orders', activePage);
      } else {
        historicoPage += delta;
        loadOrders(currentUser, 'historico-list', historicoPage);
      }
    }

    // Carregar Estatísticas do Cliente
    function loadClientStats(usuario) {
      fetch(`${API_BASE_URL}/api/pedidos/${usuario}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const stats = { total: data.pedidos.length, aguardando: 0, confirmado: 0, transito: 0, concluido: 0 };
            data.pedidos.forEach(p => {
              if (p.status === 'Aguardando Pagamento') stats.aguardando++;
              if (p.status === 'Pagamento Confirmado') stats.confirmado++;
              if (p.status === 'Em Trânsito') stats.transito++;
              if (p.status === 'Concluído') stats.concluido++;
            });
            const ctx = document.getElementById('client-stats-chart').getContext('2d');
            new Chart(ctx, {
              type: 'pie',
              data: {
                labels: ['Aguardando', 'Confirmado', 'Em Trânsito', 'Concluído'],
                datasets: [{
                  data: [stats.aguardando, stats.confirmado, stats.transito, stats.concluido],
                  backgroundColor: ['#eab308', '#16a34a', '#2563eb', '#ef4444']
                }]
              }
            });
            document.getElementById('client-stats-text').innerHTML = `
              Total de Pedidos: ${stats.total}<br>
              Aguardando Pagamento: ${stats.aguardando}<br>
              Pagamento Confirmado: ${stats.confirmado}<br>
              Em Trânsito: ${stats.transito}<br>
              Concluído: ${stats.concluido}
            `;
          }
        })
        .catch(err => console.error('Erro ao carregar estatísticas:', err));
    }

    // Carregar Perfil
    function loadProfile(email) {
      fetch(`${API_BASE_URL}/api/cliente/perfil/${email}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            document.getElementById('profile-name').value = data.perfil.nome;
            document.getElementById('profile-email').value = data.perfil.email;
            document.getElementById('profile-phone').value = data.perfil.telefone;
            document.getElementById('profile-address').value = data.perfil.endereco_padrao;
            if (data.perfil.foto_perfil) {
              document.getElementById('profile-photo-preview').src = `data:image/jpeg;base64,${data.perfil.foto_perfil}`;
              document.getElementById('profile-photo-preview').classList.remove('hidden');
            }
            document.getElementById('profile-notify').checked = data.perfil.notificar_email === 1;
          }
        })
        .catch(err => console.error('Erro ao carregar perfil:', err));
    }

    // Carregar Histórico de Pagamentos
    function loadPayments(usuario) {
      fetch(`${API_BASE_URL}/api/pagamentos/${usuario}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            displayPayments(data.pagamentos);
          } else {
            console.error('Erro ao carregar pagamentos:', data.message);
          }
        })
        .catch(err => console.error('Erro ao carregar pagamentos:', err));
    }

    // Prévia do Comprovante
    function previewComprovante(orderId, input) {
      const preview = document.getElementById(`comprovante-preview-${orderId}`);
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          preview.src = e.target.result;
          preview.classList.remove('hidden');
        };
        reader.readAsDataURL(input.files[0]);
      }
    }

    // Prévia da Foto de Perfil
    function previewProfilePhoto(input) {
      const preview = document.getElementById('profile-photo-preview');
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          preview.src = e.target.result;
          preview.classList.remove('hidden');
        };
        reader.readAsDataURL(input.files[0]);
      }
    }

    // Mostrar Modais
    function showResetPasswordModal() {
      document.getElementById('reset-password-modal').style.display = 'flex';
    }
    function hideResetPasswordModal() {
      document.getElementById('reset-password-modal').style.display = 'none';
    }
    function showRequestServiceModal() {
      document.getElementById('request-service-modal').style.display = 'flex';
    }
    function hideRequestServiceModal() {
      document.getElementById('request-service-modal').style.display = 'none';
    }
    function showPaymentConfirmationModal(details) {
      document.getElementById('payment-confirmation-details').innerHTML = details;
      document.getElementById('payment-confirmation-modal').style.display = 'flex';
    }
    function hidePaymentConfirmationModal() {
      document.getElementById('payment-confirmation-modal').style.display = 'none';
    }

    // Mostrar Formulário de Pagamento
    function showPaymentForm(orderId, orderNumber) {
      document.getElementById(`payment-form-${orderId}`).classList.toggle('hidden');
    }

    // Enviar Pagamento
    function submitPayment(event, orderId, historico) {
      event.preventDefault();
      const endereco = document.getElementById(`address-${orderId}`).value;
      const metodoPagamento = document.getElementById(`payment-method-${orderId}`).value;
      const comprovanteFile = document.getElementById(`comprovante-${orderId}`).files[0];
      const newStatus = 'Pagamento Confirmado';
      const updatedHistorico = `${historico};${new Date().toLocaleDateString()}: Pagamento confirmado via ${metodoPagamento}`;

      if (comprovanteFile) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const comprovanteBase64 = e.target.result.split(',')[1];
          sendPayment(orderId, newStatus, updatedHistorico, endereco, metodoPagamento, comprovanteBase64);
        };
        reader.readAsDataURL(comprovanteFile);
      } else {
        sendPayment(orderId, newStatus, updatedHistorico, endereco, metodoPagamento, '');
      }
    }

    function sendPayment(orderId, status, historico, endereco, metodoPagamento, comprovante) {
      fetch(`${API_BASE_URL}/api/pedidos/${orderId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status, historico, endereco, metodo_pagamento: metodoPagamento, comprovante, valor: document.getElementById(`comprovante-${orderId}`).closest('.order-card').querySelector('p:nth-child(6) strong').nextSibling.textContent.split(' ')[1] })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showNotification('Pagamento informado com sucesso!');
          const details = `
            <p><strong>Endereço:</strong> ${endereco}</p>
            <p><strong>Método:</strong> ${metodoPagamento}</p>
            <p><strong>Comprovante:</strong> ${comprovante ? '<a href="data:image/jpeg;base64,' + comprovante + '" target="_blank">Ver</a>' : 'Não enviado'}</p>
          `;
          showPaymentConfirmationModal(details);
          loadOrders(currentUser, 'active-orders', activePage);
          loadOrders(currentUser, 'historico-list', historicoPage);
          // Simulação de e-mail
          if (document.getElementById('profile-notify').checked) {
            showNotification('E-mail de confirmação enviado para ' + currentUser);
          }
        } else {
          alert('Erro ao informar pagamento: ' + data.message);
        }
      })
      .catch(err => console.error('Erro ao enviar pagamento:', err));
    }

    // Validação do Login
    document.getElementById('login-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      console.log('Tentando login com:', { email, password }); // Log para debug
      fetch(`${API_BASE_URL}/api/cliente/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password })
      })
      .then(response => {
        if (!response.ok) {
          return response.json().then(data => Promise.reject(data));
        }
        return response.json();
      })
      .then(data => {
        console.log('Resposta do backend:', data); // Log para debug
        if (data.success) {
          currentUser = email;
          document.getElementById('login-success').classList.remove('hidden');
          setTimeout(() => {
            document.getElementById('login-success').classList.add('hidden');
            loadOrders(email, 'active-orders', activePage);
            loadOrders(email, 'historico-list', historicoPage);
            loadProfile(email);
            loadPayments(email);
            document.getElementById('auth-section').style.display = 'none';
            document.getElementById('order-status').style.display = 'block';
            setTimeout(() => document.getElementById('order-status').classList.add('active'), 10);
            startPolling(email);
          }, 1000);
          this.reset();
        } else {
          document.getElementById('login-email-error').classList.remove('hidden');
          document.getElementById('login-password-error').classList.remove('hidden');
          console.error('Erro no login:', data.message);
        }
      })
      .catch(err => {
        console.error('Erro no login:', err.message || err);
        document.getElementById('login-email-error').classList.remove('hidden');
        document.getElementById('login-password-error').classList.remove('hidden');
        alert('Erro ao conectar ao servidor. Verifique o console para detalhes.');
      });
    });

    // Validação do Cadastro
    document.getElementById('cadastro-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const name = document.getElementById('cadastro-name').value;
      const email = document.getElementById('cadastro-email').value;
      const phone = document.getElementById('cadastro-phone').value;
      const address = document.getElementById('cadastro-address').value;
      const password = document.getElementById('cadastro-password').value;
      const passwordConfirm = document.getElementById('cadastro-password-confirm').value;
      let isValid = true;

      if (!name) { document.getElementById('cadastro-name-error').classList.remove('hidden'); isValid = false; } else document.getElementById('cadastro-name-error').classList.add('hidden');
      if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { document.getElementById('cadastro-email-error').classList.remove('hidden'); isValid = false; } else document.getElementById('cadastro-email-error').classList.add('hidden');
      if (phone && !/^\d{10,11}$/.test(phone.replace(/\D/g, ''))) { document.getElementById('cadastro-phone-error').classList.remove('hidden'); isValid = false; } else document.getElementById('cadastro-phone-error').classList.add('hidden');
      if (!password) { document.getElementById('cadastro-password-error').classList.remove('hidden'); isValid = false; } else document.getElementById('cadastro-password-error').classList.add('hidden');
      if (password !== passwordConfirm) { document.getElementById('cadastro-password-confirm-error').classList.remove('hidden'); isValid = false; } else document.getElementById('cadastro-password-confirm-error').classList.add('hidden');

      if (isValid) {
        fetch(`${API_BASE_URL}/api/cliente/cadastro`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, senha: password, nome: name, telefone: phone, endereco_padrao: address })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            currentUser = email;
            document.getElementById('cadastro-success').classList.remove('hidden');
            setTimeout(() => {
              document.getElementById('cadastro-success').classList.add('hidden');
              loadOrders(email, 'active-orders', activePage);
              loadOrders(email, 'historico-list', historicoPage);
              loadProfile(email);
              loadPayments(email);
              document.getElementById('auth-section').style.display = 'none';
              document.getElementById('order-status').style.display = 'block';
              setTimeout(() => document.getElementById('order-status').classList.add('active'), 10);
              startPolling(email);
            }, 1000);
            this.reset();
          } else {
            alert('Erro ao cadastrar: ' + data.message);
          }
        })
        .catch(err => console.error('Erro no cadastro:', err));
      }
    });

    // Atualizar Perfil
    document.getElementById('profile-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const email = document.getElementById('profile-email').value;
      const name = document.getElementById('profile-name').value;
      const phone = document.getElementById('profile-phone').value;
      const address = document.getElementById('profile-address').value;
      const notify = document.getElementById('profile-notify').checked ? 1 : 0;
      const photoFile = document.getElementById('profile-photo').files[0];

      if (photoFile) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const fotoBase64 = e.target.result.split(',')[1];
          updateProfile(email, name, phone, address, fotoBase64, notify);
        };
        reader.readAsDataURL(photoFile);
      } else {
        updateProfile(email, name, phone, address, '', notify);
      }
    });

    function updateProfile(email, name, phone, address, foto_perfil, notificar_email) {
      fetch(`${API_BASE_URL}/api/cliente/perfil`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, nome: name, telefone: phone, endereco_padrao: address, foto_perfil, notificar_email })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showNotification('Perfil atualizado com sucesso!');
          if (notificar_email) showNotification('E-mail de confirmação enviado para ' + email);
        } else {
          alert('Erro ao atualizar perfil: ' + data.message);
        }
      })
      .catch(err => console.error('Erro ao atualizar perfil:', err));
    }

    // Enviar Solicitação de Suporte
    document.getElementById('support-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const subject = document.getElementById('support-subject').value;
      const message = document.getElementById('support-message').value;
      showNotification('Solicitação de suporte enviada com sucesso! Assunto: ' + subject);
      if (document.getElementById('profile-notify').checked) {
        showNotification('E-mail de confirmação enviado para ' + currentUser);
      }
      this.reset();
    });

    // Enviar Solicitação de Serviço
    document.getElementById('request-service-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const service = document.getElementById('request-service').value;
      const description = document.getElementById('request-description').value;
      const orderData = {
        numero: `SOL-${Date.now()}`,
        data: new Date().toISOString().split('T')[0],
        servico: service,
        descricao: description,
        status: 'Solicitação Pendente',
        historico: `${new Date().toLocaleDateString()}: Solicitação enviada pelo cliente`,
        usuario: currentUser,
        solicitacao: 1
      };
      fetch(`${API_BASE_URL}/api/pedidos`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(orderData)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showNotification('Solicitação de serviço enviada com sucesso!');
          if (document.getElementById('profile-notify').checked) {
            showNotification('E-mail de confirmação enviado para ' + currentUser);
          }
          hideRequestServiceModal();
          loadOrders(currentUser, 'active-orders', activePage);
          this.reset();
        } else {
          alert('Erro ao enviar solicitação: ' + data.message);
        }
      })
      .catch(err => console.error('Erro ao enviar solicitação:', err));
    });

    // Recuperação de Senha (Simulada)
    document.getElementById('reset-password-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const email = document.getElementById('reset-email').value;
      if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        document.getElementById('reset-email-error').classList.remove('hidden');
      } else {
        document.getElementById('reset-email-error').classList.add('hidden');
        showNotification('Código de recuperação enviado para ' + email + ' (simulação)');
        hideResetPasswordModal();
      }
    });

    // Polling para Atualização em Tempo Real
    function startPolling(usuario) {
      setInterval(() => {
        loadOrders(usuario, 'active-orders', activePage);
        loadOrders(usuario, 'historico-list', historicoPage);
      }, 30000); // Atualiza a cada 30 segundos
    }

    // Exportar para CSV
    function exportClientToCSV() {
      const csv = Papa.unparse(currentOrders.map(p => ({
        Número: p.numero,
        Data: p.data,
        Serviço: p.servico,
        Descrição: p.descricao,
        Transporte: p.transporte,
        Entrega: p.entrega,
        Instalação: p.instalacao,
        Manutenção: p.manutencao,
        Status: p.status,
        Histórico: p.historico,
        Endereço: p.endereco,
        Pagamento: p.metodo_pagamento,
        Valor: p.valor
      })));
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'meus_pedidos.csv';
      link.click();
    }

    // Exportar para PDF
    function exportClientToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text('Meus Pedidos - Nort Elétrica', 10, 10);
      let y = 20;
      currentOrders.forEach(p => {
        doc.text(`Número: ${p.numero} | Status: ${p.status}`, 10, y);
        y += 10;
        doc.text(`Serviço: ${p.servico} | Valor: R$ ${p.valor}`, 10, y);
        y += 10;
        doc.text(`Histórico: ${p.historico}`, 10, y);
        y += 20;
      });
      doc.save('meus_pedidos.pdf');
    }
  </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'91a560850f65451f',t:'MTc0MDk2NTUxNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>